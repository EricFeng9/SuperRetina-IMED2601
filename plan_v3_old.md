
我现在在做一个课题，目标是目标是基于我们已有的生成数据集（结构完全相同且对齐的cf-oct-fa图像对）训练出一个支持cf-fa，cf-oct（cf均为fix）的多模态配准模型。我们目前在用fractMorph模型进行2D化改造后的模型，但是fractMorph2D只能针对一些微小血管形变进行对齐和修复，但是针对真实情况不对齐图像中出现的血管大尺度旋转（如15 30度的旋转角度）、大的位置偏移的情况下配准效果较差，1是原先的逐像素点移动的模式很差2是我们修改成让模型直接预测放射参数，效果也很差，几乎不收敛。我现在的想法是改造SuperRetina，让模型学习cf图像和oct/fa图像之间的关键点匹配，然后利用这些匹配出来的关键点计算放射矩阵，对跨模态图像进行配准
# 跨模态 SuperRetina 详细训练计划 (Plan v3)

这份计划基于 **SuperRetina** 的半监督学习框架，并结合了**描述子热身 (Descriptor Warm-up)** 策略，以解决跨模态配准中的"鸡生蛋"问题（即：没有好的描述子就找不到匹配点，找不到匹配点就无法训练好描述子）。

---

## 1. 核心训练策略：两阶段课程学习
### 关键点提取算法

实现位置：`common/vessel_keypoint_extractor.py`

**核心步骤**：
1. **骨架化（Skeletonization）**：将粗血管线变成单像素宽的中心线
   - 使用 `cv2.ximgproc.thinning()` 或 `skimage.morphology.skeletonize()`
2. **邻居统计**：对每个骨架点统计 3×3 邻域内的邻居数量
3. **关键点识别**：
   - **分叉点**：邻居数 ≥ 3 的骨架点
4. **非极大值抑制（NMS）**：去除距离过近的重复点（`min_distance=8` 像素）

**参数**：
- `min_distance`：关键点之间的最小距离，默认 8 像素

我们将训练过程明确分为两个阶段：

### 第一阶段：描述子热身期 (Descriptor Warm-up)
- **周期**：Epoch 0 - 20
- **目标**：在没有任何可靠检测器的情况下，利用血管结构本身的拓扑特征（分叉点、交叉点）作为强监督信号，优先训练出对旋转、模态变化鲁棒的描述子。
- **机制**：
    - **冻结 PKE**：此阶段不使用 PKE 进行关键点扩充，防止低质量描述子引入错误标签。
    - **强制监督**：利用固定图像（CF）的血管分割图提取关键点（分叉点/交叉点），作为 Ground Truth (GT) 锚点。
    - **忽略检测损失**：模型预测的检测热力图被强制清零，仅在 GT 锚点位置赋予高响应，迫使模型只学习这些特定位置的描述子特征。
    - **损失计算**：仅计算 **描述子损失 ($l_{des}$)**，忽略检测损失 ($l_{det}$)。

### 第二阶段：联合训练期 (Joint Training)
- **周期**：Epoch 20+
- **目标**：利用已经具备一定辨识度的描述子，开启 PKE 自监督机制，让模型自动发现更多潜在的、非血管结构的稳定特征点，同时训练检测器。
- **机制**：
    - **开启 PKE**：激活渐进式关键点扩充模块，动态生成伪标签 ($Y_t$)。
    - **联合优化**：同时计算 **检测损失 ($l_{det}$)** 和 **描述子损失 ($l_{des}$)**。

---

## 2. 详细训练流程 (Training Workflow)

在每个 Epoch 的每个 Batch 中，数据流向如下：

### A. 数据准备与增强
1.  **输入加载**：读取对齐的图像对 $I_{fix}$ (CF) 和 $I_{orig}$ (FA/OCT)。
2.  **GT 种子点提取**：
    -   读取 $I_{fix}$ 对应的血管分割图 `vessel_mask0`。
    -   对分割图进行骨架化 (Skeletonization) 和 3x3 邻域分析，提取**分叉点**和**交叉点**。
    -   这些点构成当前 Batch 的基础监督信号 `vessel_keypoints`。
3.  **几何变换 (Geometric Augmentation)**：
    -   生成随机单应性矩阵 $\mathcal{H}$（包含 $\pm30^\circ$ 旋转、平移、缩放）。
    -   对 $I_{orig}$ 进行变换得到 $I_{moving} = \text{Warp}(I_{orig}, \mathcal{H})$。
    -   **重点**：此时我们拥有 $I_{fix}$ 上的点 $p$ 和 $I_{moving}$ 上对应的点 $p' = \mathcal{H}(p)$ 的精确几何关系。

### B. 前向传播与损失计算
1.  **特征提取**：
    -   $I_{fix} \to$ `det_fix`, `desc_fix`
    -   $I_{moving} \to$ `det_mov`, `desc_mov`
2.  **热身期逻辑 (Epoch <= 20)**：
    -   设置 `model.PKE_learn = False`。
    -   在计算损失时，手动将 `det_fix` 在 GT `vessel_keypoints` 位置的值设为最大，其余位置设为 0。
    -   利用 $\mathcal{H}^{-1}$ 网格，在 $I_{moving}$ 上采样对应位置的描述子。
    -   计算 Triplet Loss：拉近 $I_{fix}$ 上的 GT 点和 $I_{moving}$ 上对应点的描述子距离，推远非对应点。
    - **联合期逻辑 (Epoch > 20)**：
    -   设置 `model.PKE_learn = True`。
    -   **PKE 模块运行**：
        1.  **候选点生成**：从检测图提取候选点。
        2.  **掩码过滤 (Mask Filtering)**：利用 `vessel_mask0` 剔除落在背景区域的候选点，**仅保留血管上的点**作为潜在标签。这能有效抑制背景噪声。
        3.  **几何校验**：将 `det_mov` 反投影回 `fix` 空间，检查重叠度。
        4.  **内容校验**：对重叠点进行 Lowe's Ratio Test（利用已学好的描述子）。
        5.  **标签更新**：将通过校验的点加入动态标签 $Y_t$。
    -   计算 Dice Loss 优化检测图，计算 Triplet Loss 优化描述子。

---

## 3. 详细验证流程 (Validation Workflow)

验证过程旨在客观评估模型的配准能力，避免随机性干扰。

### A. 数据缓存机制 (Caching Strategy)
为了保证每次验证的可比性，我们在**第一次验证时**（Epoch 0）构建一个固定的验证子集：
1.  **固定种子**：设置 `torch.manual_seed(2024)`确保随机选取的样本在不同实验中一致。
2.  **采样数量**：从验证集中随机抽取 **10 个样本**（若不足 10 个则全选）。
3.  **缓存内容**：将这 10 个样本的图像数据、原始名称等全部加载到内存 (`val_cache`)，后续验证 Epoch 直接复用，不再重复从磁盘读取。

### B. 评估指标：配准 MSE
对于每个验证样本：
1.  **推断**：模型分别处理 $I_{fix}$ 和 $I_{moving}$，输出检测图和描述子。
2.  **后处理**：
    -   应用 **NMS (非极大值抑制)** 提取 Top-K 关键点。
    -   **兜底策略**：如果 NMS 后点数少于 10 个，强制选取响应值最高的 100 个点（防止初期无法配准）。
3.  **特征匹配**：使用 BFMatcher + Lowe's Ratio Test (`thresh=0.7`) 寻找匹配对。
4.  **单应性估计**：使用 **RANSAC** (`thresh=3.0` 像素) 计算变换矩阵 $\hat{\mathcal{H}}$。
5.  **配准误差计算**：
    -   利用 $\hat{\mathcal{H}}$ 对 $I_{moving}$ 进行变换得到 $I_{reg}$。
    -   计算 $I_{reg}$ 与原始对齐真值 $I_{orig}$ 之间的 **均方误差 (MSE)**。
    -   若配准失败（匹配点不足4个），MSE 设为极大值 (10000.0)。

### C. 可视化输出
验证过程中会自动保存以下图片用于人工检查（路径：`save/.../epochX/sampleY/`）：
1.  `vessel_keypoints_extracted.png`：[新增] 显示从血管分割图提取的**红色 GT 关键点**。这是确认“热身期监督信号”是否正确的关键。
2.  `fixed_kps.png`：模型在 $I_{fix}$ 上预测的**绿色关键点**。
3.  `matches.png`：跨模态图像之间的关键点连线图。
4.  `registered.png`：最终配准叠加效果图。

---

## 4. 损失函数细节

### 检测损失 (仅联合期)
$$l_{clf} = 1 - \text{Dice}(P, \text{GaussianSmooth}(Y_t))$$
目标是让预测的热力图 $P$ 拟合动态演化的标签 $Y_t$。

### 描述子损失 (全程)
使用 **Triplet Margin Loss**：
$$l_{des} = \max(0, m + d(f_a, f_p) - d(f_a, f_n))$$
-   $f_a$ (Anchor): 固定图像 GT 血管点处的描述子。
-   $f_p$ (Positive): 运动图像对应几何位置处的描述子。
-   $f_n$ (Negative): 运动图像上其他位置（Hardest Negative Mining）的描述子。

---

## 5. 预期效果
-   **Epoch 0-20**：`loss_det` 应为 0。验证集 MSE 可能较高，但 `matches.png` 中的连线应逐渐变准（因为描述子在变好）。
-   **Epoch 20+**：`loss_det` 开始上升（因为开始学习检测），随后下降。PKE 扩充的点数应逐渐增加。最终 MSE 应稳定在较低水平，实现精确配准。
