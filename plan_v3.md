good
我现在在做一个课题，目标是目标是基于我们已有的生成数据集（结构完全相同且对齐的cf-oct-fa图像对）训练出一个支持cf-fa，cf-oct（cf均为fix）的多模态配准模型。我们目前在用fractMorph模型进行2D化改造后的模型，但是fractMorph2D只能针对一些微小血管形变进行对齐和修复，但是针对真实情况不对齐图像中出现的血管大尺度旋转（如15 30度的旋转角度）、大的位置偏移的情况下配准效果较差，1是原先的逐像素点移动的模式很差2是我们修改成让模型直接预测放射参数，效果也很差，几乎不收敛。我现在的想法是改造SuperRetina，让模型学习cf图像和oct/fa图像之间的关键点匹配，然后利用这些匹配出来的关键点计算放射矩阵，对跨模态图像进行配准

这份计划基于 **SuperRetina** 的半监督学习框架，针对你提到的多模态（CF、FA、OCT）大尺度配准需求进行了深度细化。我们将整个流程分为：**数据预处理、动态标签演化、多损失联合优化、以及基于特征点的稳健推断**。

---

# 跨模态 SuperRetina 详细训练计划 (Plan v3)

## 1. 数据构造与空间变换

每一轮迭代 (Iteration) 中，我们利用对齐的图像对构造具有几何偏差的跨模态输入：

*   **输入对**：固定图像 $I_{fix}$（CF 模态）和原始运动图像 $I_{mo}$（FA 或 OCT 模态）。
*   **初始种子点 ($Y_0$)**：在 $I_{fix}$ 上使用 PBO 算法自动提取血管交叉点和分叉点。这作为“冷启动”阶段的监督信号。
*   **几何扰动 ($\mathcal{H}$)**：随机生成单应性矩阵 $\mathcal{H}$，对 $I_{mo}$ 进行变换：
    $$I_{moving} = \text{Warp}(I_{mo}, \mathcal{H})$$
*   **变换范围**：旋转 $\theta \in [-30^\circ, 30^\circ]$，平移 $t \in [0.1, 0.2] \times \text{Size}$。

## 2. 网络前向传播

$I_{fix}$ 和 $I_{moving}$ 分别通过共享权重的编码器及双解码器：

*   **检测图 (Detection Map)**：输出 $P$ 和 $P'$，表示每个像素是关键点的概率。
*   **描述子张量 (Descriptor Tensor)**：输出 $D$ 和 $D'$，维度均为 $h \times w \times 256$。

## 3. 跨模态渐进式关键点扩充 (PKE)

这是解决标注不全和模态差异的核心模块。在每轮训练中，模型通过以下逻辑自我进化：

### A. 几何校验 (Geometric Verification)

将 $P'$ 投影回 $I_{fix}$ 的坐标系：
$$P'_* = \text{Warp}(P', \mathcal{H}^{-1})$$

判定重现性点集 $\hat{S}$：
$$\hat{S} = \{(i, j) \mid P_{i,j} > 0.5 \text{ 且 } (P'_*)_{i,j} > 0.5\}$$

### B. 内容校验 (Content Verification / Double Matching)

对 $\hat{S}$ 中的点提取描述子进行双重匹配：

*   **Lowe's Ratio Test**：计算 $I_{fix}$ 中点 $(i, j)$ 的描述子与 $I_{moving}$ 中对应点描述子的欧氏距离。只有当最优匹配距离明显小于次优匹配距离时，该点才被加入可靠集合 $S_t$。
*   **标签更新**：$Y_t = Y_0 \cup S_t$。

## 4. 训练策略：描述子热身 (Descriptor Warm-up)

为了解决"鸡生蛋"问题（即描述子不好导致匹配失败，匹配失败导致无法训练描述子），引入**描述子热身期**。

| 阶段 | 周期 (Epochs) | 状态 | 目的 |
|---|---|---|---|
| **0. 描述子热身期** | 0 - 20 | **仅描述子训练** | 冻结检测器，利用 GT 关键点强制训练描述子，解决 Ratio Test 失败问题。在此阶段，PKE 暂时关闭或仅作为验证，重点优化描述子损失。 |
| **1. 联合训练期** | 20+ | **全模型训练** | 解冻检测器，开启 PKE，进行正常的端到端联合训练。 |

**热身期逻辑**：
1.  **冻结检测器参数**：只更新描述子分支的权重。
2.  **强制监督**：使用初始种子点 $Y_0$ 作为锚点，直接计算对应位置在 $I_{moving}$ 上的描述子距离，优化三元组损失。
3.  **不依赖 PKE 扩充**：在热身阶段不依赖 PKE 扩充的关键点，而是确保基础的血管交叉/分叉点具有可区分的跨模态特征。

## 5. 详细损失函数 (Loss Functions)

模型通过最小化综合损失 $L = l_{det} + l_{des}$ 进行优化：

### I. 检测损失 ($l_{det}$)

由分类损失和几何一致性损失组成：

1.  **分类损失 ($l_{clf}$)**：使用 Dice Loss 强制 $P$ 拟合动态标签 $Y_t$：
    $$l_{clf}(I; Y_t) = 1 - \frac{2 \cdot \sum_{i,j}(P \circ \tilde{Y}_t)_{i,j}}{\sum_{i,j}(P \circ P)_{i,j} + \sum_{i,j}(\tilde{Y}_t \circ \tilde{Y}_t)_{i,j}}$$
    其中 $\tilde{Y}_t$ 是对 $Y_t$ 进行 2D 高斯模糊后的软标签。
2.  **几何一致性损失 ($l_{geo}$)**：强制跨模态生成的检测图在空间上对齐：
    $$l_{geo}(I, \mathcal{H}) = \text{DiceLoss}(P, P'_*)$$

### II. 描述子损失 ($l_{des}$)

使用改进的跨模态三元组损失：
$$l_{des}(I; \mathcal{H}) = \sum_{(i,j) \in \hat{P}} \max(0, m + \phi_{i,j} - \frac{1}{2}(\phi_{i,j}^{rand} + \phi_{i,j}^{hard}))$$

*   $\phi_{i,j}$：相同解剖点在 CF 和 FA/OCT 模态描述子间的欧氏距离。
*   $\phi_{i,j}^{rand} / \phi_{i,j}^{hard}$：随机负样本和最难负样本的特征距离。
*   **意义**：该损失强制将不同模态的血管特征映射到统一的旋转不变特征空间。

## 6. 推断与配准 (Inference & Registration)

针对大尺度旋转，采用基于特征点的全局解算：

1.  **特征点检测**：对待配准图 $I_1, I_2$ 提取关键点集 $Kp_1, Kp_2$。
2.  **特征匹配**：基于 256 维描述子的欧氏距离进行暴力匹配。
3.  **单应性解算**：
    $$\hat{\mathcal{H}} = \text{RANSAC}(\text{Matches}(Kp_1, Kp_2))$$
*   **优点**：即使存在 $30^\circ$ 旋转或大面积偏移，只要存在 4 个以上的正确匹配点，RANSAC 即可实现像素级对齐，鲁棒性远超逐像素位移模型。
