# SuperRetina 多模态配准训练方案 (Plan v2)
我现在在做一个课题，目标是目标是基于我们已有的生成数据集（结构完全相同且对齐的cf-oct-fa图像对）训练出一个支持cf-fa，cf-oct（cf均为fix）的多模态配准模型。我们目前在用fractMorph模型进行2D化改造后的模型，但是fractMorph2D只能针对一些微小血管形变进行对齐和修复，但是针对真实情况不对齐图像中出现的血管大尺度旋转（如15 30度的旋转角度）、大的位置偏移的情况下配准效果较差，1是原先的逐像素点移动的模式很差2是我们修改成让模型直接预测放射参数，效果也很差，几乎不收敛。我现在的想法是改造SuperRetina，让模型学习cf图像和oct/fa图像之间的关键点匹配，然后利用这些匹配出来的关键点计算放射矩阵，对跨模态图像进行配准
## 项目背景与目标

基于已有的生成数据集（结构完全相同且对齐的 CF-OCT-FA 图像对），训练一个支持 CF-FA、CF-OCT 跨模态配准的模型（CF 均为 fix）。

### 核心挑战
- **大尺度旋转**：真实场景中存在 15°-30° 的旋转角度
- **大位置偏移**：显著的平移偏移
- **模态差异**：CF、FA、OCT 之间的外观差异巨大

### 解决方案
采用 **SuperRetina** 框架，通过学习跨模态的关键点匹配，利用 RANSAC 计算仿射矩阵进行配准。相比逐像素位移的方法，基于特征点的全局解算对大尺度变换具有更强的鲁棒性。

---

## 1. 核心改进：血管掩码引导 + 稀疏关键点监督

### 1.1 设计理念

**问题诊断**：
- 如果直接将完整的血管分割图（连续线条）作为关键点监督，会导致模型在血管线上的每个像素都学习到相似的描述子
- 这些点缺乏区分度（孔径问题），导致 Lowe's Ratio Test 失败，匹配数量极少

**解决方案**：
- **训练时**：从完整血管分割图中提取稀疏的**分叉点、交叉点、端点**作为监督信号
- **推理时**：模型完全不依赖血管掩码，自主检测关键点（因为已经学会了什么是"好的关键点"）

### 1.2 关键点提取算法

实现位置：`common/vessel_keypoint_extractor.py`

**核心步骤**：
1. **骨架化（Skeletonization）**：将粗血管线变成单像素宽的中心线
   - 使用 `cv2.ximgproc.thinning()` 或 `skimage.morphology.skeletonize()`
2. **邻居统计**：对每个骨架点统计 3×3 邻域内的邻居数量
3. **关键点识别**：
   - **分叉点**：邻居数 ≥ 3 的骨架点
   - **端点**：邻居数 = 1 的骨架点
4. **非极大值抑制（NMS）**：去除距离过近的重复点（`min_distance=8` 像素）

**参数**：
- `min_distance`：关键点之间的最小距离，默认 8 像素

### 1.3 训练流程中的应用

**数据集层面**（`dataset/FIVES_extract_v2/FIVES_extract_v2.py`）：
- 返回完整的血管分割图 `vessel_mask0`（保持数据集简洁）

**训练脚本层面**（`train_multimodal_v3.py`）：
- 在每个训练 batch 中，动态提取关键点：
  ```python
  vessel_mask_full = data['vessel_mask0']  # [B, 1, H, W]
  vessel_keypoints = extract_vessel_keypoints(mask_np, min_distance=8)
  ```
- 将提取的稀疏关键点掩码传入模型作为监督信号

**验证可视化**：
- 新增 `vessel_keypoints_extracted.png`：显示从血管分割图中提取的红色关键点
- 对比 `fixed_kps.png`：显示模型实际检测到的绿色关键点

---

## 2. 损失函数的权重改造（Gradient Guard）

### 2.1 检测损失的权重引导 ($l_{det}$)

修改原有的 Dice Loss，引入基于掩码的权重图 $W_{vessel}$：

$$l_{clf\_weighted} = 1 - \frac{2 \cdot \sum(P \circ \tilde{Y}_t \circ W_{vessel})}{\sum(P^2 \circ W_{vessel}) + \sum(\tilde{Y}_t^2 \circ W_{vessel})}$$

**权重构造**：
- 基于血管掩码的距离变换计算高斯软权重：
  $$W_{vessel}(x) = \exp\left(-\frac{D(x)^2}{2\sigma^2}\right)$$
  其中 $D(x)$ 是像素 $x$ 到最近血管的距离，$\sigma$ 为高斯核参数（默认 6.0 像素）

**物理意义**：
- 血管区域权重接近 1.0，非血管区域权重平滑衰减
- 通过三阶段课程学习动态调整最小权重（见下文）

### 2.2 描述子损失的掩码加权 ($l_{des}$)

在计算跨模态的三元组损失时，根据点是否在血管上调整梯度贡献力度：

$$l_{des\_weighted} = \sum_{(i,j) \in P} w_{i,j} \cdot \max(0, m + \phi_{i,j} - \frac{1}{2}(\phi_{i,j}^{rand} + \phi_{i,j}^{hard}))$$

**点权重**：$w_{i,j} = M^{vessel}(i, j) \cdot 0.9 + 0.1$

**意义**：确保血管分叉处的关键点具有更强的特征辨识度和鲁棒性。

---

## 3. PKE 模块的掩码协同（Mask-Guided PKE）

**PKE（筛选式关键点扩充）** 是 SuperRetina 的核心，引入掩码可以极大降低监督学习初期的噪声。

### 3.1 筛选逻辑改进

在原有的**几何校验**和**内容校验**（双重匹配）基础上，增加**掩码一致性校验**：

1. **原有流程**：通过 $\mathcal{H}^{-1}$ 反投影寻找重现点 $S$，并进行 Lowe's Ratio Test
2. **新增掩码过滤**（可选，当前实现中未强制）：
   $$\hat{S}_{final} = \{(i, j) \in \hat{S} \mid M^{vessel}(i, j) > 0.5\}$$
3. **动态标签更新**：$Y_t = Y_0 \cup \hat{S}_{final}$

**作用**：在训练初期，强制模型更新学习到的"关键点"必须落在血管掩码内，防止在缺乏对比度的区域学习到错误的关键点。

---

## 4. 训练策略：三阶段课程学习（Curriculum Learning）

为了解决"测试时无掩码"的问题，采用**渐衰权重 λ** 调节掩码的影响力。

| 阶段 | 周期 (Epochs) | 掩码权重最小值 | 目的 |
|------|---------------|----------------|------|
| **1. 全局感知期** | 0 - 30 | min_weight = 0.3 | 让模型利用全局信息（含背景）学习初步的 ±30° 几何对齐 |
| **2. 血管聚焦期** | 30 - 60 | min_weight = 0.1 | **强化血管引导**。PKE 大量引入血管分叉点，模型学习跨模态的关键点对应细微拓扑特征 |
| **3. 泛化增强期** | 60 - 100 | min_weight = 0.5 | 减弱掩码对比度。模型在"弱掩码"环境下，确保仅识别出血管关键点也能对齐 |
| **4. 完全泛化期** | 100+ | min_weight = 0.0 | **掩码权重归零**。模型完全依赖学到的特征进行配准，模拟真实测试环境 |

**实现函数**：`get_vessel_weight_min(epoch)`

---

## 5. 数据构造与空间变换

### 5.1 数据准备

每一轮迭代中，利用对齐的图像对构造具有几何偏差的跨模态输入：

- **输入对**：固定图像 $I_{fix}$（CF 模态）和原始运动图像 $I_{mo}$（FA 或 OCT 模态）
- **初始种子点 ($Y_0$)**：从血管分割图中提取的稀疏关键点（分叉点、交叉点、端点）
- **几何扰动 ($\mathcal{H}$)**：随机生成单应性矩阵 $\mathcal{H}$，对 $I_{mo}$ 进行变换：
  $$I_{moving} = \text{Warp}(I_{mo}, \mathcal{H})$$

### 5.2 变换范围

**训练阶段**：
- 旋转：$\theta \in [-45°, 45°]$
- 缩放：$scale \in [0.9, 1.1]$
- 平移：$t \in [-0.1, 0.1] \times \text{ImageSize}$
- 翻转：水平/垂直翻转概率各 10%

**验证阶段**：
- 使用固定随机种子（基于样本索引），保证每次验证时的形变一致

### 5.3 血管掩码同步变换

$M_{vessel}^{moving} = \text{Warp}(M_{vessel}, \mathcal{H})$

确保掩码与图像的几何关系保持一致。

---

## 6. 网络前向传播

$I_{fix}$ 和 $I_{moving}$ 分别通过共享权重的编码器及双解码器：

- **检测图（Detection Map）**：输出 $P$ 和 $P'$，表示每个像素是关键点的概率
- **描述子张量（Descriptor Tensor）**：输出 $D$ 和 $D'$，维度均为 $h \times w \times 256$

**重要**：血管掩码**不**作为输入送入 Encoder，仅用于损失计算和 PKE。

---

## 7. 推断与配准（Inference & Registration）

针对大尺度旋转，采用基于特征点的全局解算：

1. **特征点检测**：对待配准图 $I_1, I_2$ 提取关键点集 $Kp_1, Kp_2$
2. **特征匹配**：基于 256 维描述子的欧氏距离进行暴力匹配（BFMatcher）
3. **Lowe's Ratio Test**：`content_thresh = 0.7`（可调）
4. **单应性解算**：
   $$\hat{\mathcal{H}} = \text{RANSAC}(\text{Matches}(Kp_1, Kp_2))$$
   - RANSAC 重投影误差阈值：`geometric_thresh = 3.0` 像素

**优点**：即使存在 $30°$ 旋转或大面积偏移，只要存在 4 个以上的正确匹配点，RANSAC 即可实现像素级对齐。

---

## 8. 实现细节与改进

### 8.1 关键点提取的实现位置

- **提取工具**：`common/vessel_keypoint_extractor.py`
  - `extract_vessel_keypoints()`：使用 OpenCV 的 `ximgproc.thinning()`
  - `extract_vessel_keypoints_fallback()`：使用 scikit-image 的 `skeletonize()`（备用方案）

- **调用位置**：`train_multimodal_v3.py` 训练循环中
  - 每个 batch 动态提取关键点
  - 验证时也提取关键点用于可视化

### 8.2 验证可视化增强

**新增输出**：
- `vessel_keypoints_extracted.png`：显示从血管分割图中提取的稀疏关键点（红色点）
- 对比 `fixed_kps.png`：显示模型实际检测到的关键点（绿色点）

**原有输出**：
- `fixed_kps.png`：固定图像 + 检测到的关键点
- `affined_moving_kps.png`：变换后的移动图像 + 检测到的关键点
- `matches.png`：匹配连线可视化
- `registered.png`：配准结果

### 8.3 日志系统

**训练日志**（`train_log.txt`）：
- 记录所有控制台输出（epoch 信息、损失、验证结果等）
- 实时写入（行缓冲）

**验证日志**（`validation_log.txt`）：
- 记录每次验证的详细 MSE 结果

**Checkpoint 信息**（`checkpoint_info.txt`）：
- 保存在 `bestcheckpoint/` 和 `latestpoint/` 目录下
- 记录对应的 epoch 和 MSE 值

### 8.4 早停机制

- **启用时机**：epoch ≥ 100
- **耐心值**：patience = 5（连续 5 次验证 MSE 不下降则停止）
- **最佳模型**：自动保存 MSE 最低的模型

---

## 9. 配置参数

### 9.1 关键超参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `nms_thresh` | 0.01 | NMS 阈值，用于关键点检测 |
| `content_thresh` | 0.7 | Lowe's Ratio Test 阈值 |
| `geometric_thresh` | 3.0 | RANSAC 重投影误差阈值（像素） |
| `vessel_sigma` | 6.0 | 血管权重高斯核的 σ 参数 |
| `pke_start_epoch` | 配置文件 | PKE 模块启用的起始 epoch |
| `img_size` | 512 | 图像统一缩放尺寸 |
| `batch_size` | 4 | 训练批次大小 |

### 9.2 命令行参数

```bash
python train_multimodal_v3.py \
  --name exp_name \
  --mode cffa \
  --epoch 500 \
  --batch_size 4 \
  --vessel_sigma 6.0
```

---

## 10. 问题诊断与解决方案总结

### 10.1 原始问题

**现象**：
- 关键点检测正确（都在血管周围）
- 但匹配数量极少（matches 几乎为 0）

**根本原因**：
- 将完整的血管分割图（连续线条）直接作为关键点监督
- 导致模型在血管线上的每个像素都学到相似的描述子
- Lowe's Ratio Test 失败：`dist(best) ≈ dist(second_best)`

### 10.2 解决方案

**核心思路**：
- 从完整血管分割图中提取稀疏的、独特的关键点（分叉点、交叉点、端点）
- 只在这些独特位置提供监督信号
- 模型学到的描述子具有区分度，匹配成功率大幅提升

**实现方式**：
- 骨架化 + 邻居统计 + NMS
- 训练时动态提取，推理时完全不依赖

### 10.3 为什么不扩展血管掩码？

**用户原始猜测**：把血管掩码向周围扩展几个像素？

**答案**：**不能**，这会使问题更严重
- 扩展掩码会让血管壁旁边的背景点也被学进去
- 导致更多的重复纹理和更多的模糊匹配
- 正确做法是**收缩**监督范围，只保留最独特的点

---

## 11. 总结

通过上述改进，SuperRetina 可以：

1. **训练时**：充分利用血管掩码引导学习关键的血管特征点（分叉点、交叉点）
2. **推理时**：完全不依赖掩码，自主检测独特的关键点
3. **泛化能力**：通过课程学习和梯度保底策略，确保模型在无掩码情况下依然具有极强的泛化能力和大尺度配准鲁棒性

**关键创新点**：
- 稀疏关键点监督（而非完整血管线）
- 三阶段课程学习（逐步减弱掩码依赖）
- 高斯软权重（梯度保底机制）
- 完善的日志和可视化系统

**预期效果**：
- 匹配数量显著增加
- 配准精度提升
- 对大角度旋转（±30°）和大位移具有鲁棒性
