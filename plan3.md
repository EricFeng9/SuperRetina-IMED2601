# SuperRetina 血管掩码引导配准改进方案 (Plan v3)

针对你希望在 SuperRetina 框架中引入类似 LoFTR 的**血管掩码引导**(Vessel Mask Guidance)**的需求,核心目标是:利用训练集中的血管掩码引导模型更关注血管特征(分叉、交叉点),同时通过"梯度保底"和"课程学习"确保模型在推理阶段(无掩码)依然具有极强的泛化能力。

以下是针对 SuperRetina 计划的详细修改方案:

---

## 1. 核心改进逻辑:从"硬输入"转为"软损失权重"

为了确保模型在测试阶段不依赖掩码,我们**严禁将掩码信息注入到 Encoder**。相反,我们将掩码信息注入到**损失函数权重和 PKE (筛选式关键点扩充)** 筛选逻辑中。

---

## 2. 损失函数的权重改造 (Loss Reweighting)

我们引入 **Gradient Guard (梯度保底)** 机制,确保背景区域也能提供微弱梯度以维持大尺度配准所需的全局空间感知。

### A. 检测损失的权重引导 ($l_{det}$)

修改原有的 Dice Loss,引入基于掩码的权重图 $W_{vessel}$:

$$l_{clf\_weighted} = 1 - \frac{2 \cdot \sum(P \circ \tilde{Y}_t \circ W_{vessel})}{\sum(P^2 \circ W_{vessel}) + \sum(\tilde{Y}_t^2 \circ W_{vessel})}$$

*   **权重构造**: $W_{vessel} = \text{clamp}(M^{vessel}, \min=0.1)$。
*   **物理意义**: 血管区域权重为 1.0,非血管区域保留 0.1 的权重。这强制模型优先拟合血管上的关键点,但**不会完全忽略背景纹理**,从而在转移到大尺度偏移时依然能通过边缘信号进行对齐。

### B. 描述子损失的掩码加权 ($l_{des}$)

在计算跨模态的三元组损失时,根据点是否在血管上调整梯度贡献力度:

$$l_{des\_weighted} = \sum_{(i,j) \in P} w_{i,j} \cdot \max(0, m + \phi_{i,j} - \frac{1}{2}(\phi_{i,j}^{rand} + \phi_{i,j}^{hard}))$$

*   **点权重**: $w_{i,j} = M^{vessel}(i, j) \cdot 0.9 + 0.1$。
*   **意义**: 该损失确保在血管分叉处的关键点具有更强的特征辨识度和鲁棒性,这是处理 30° 以上旋转的关键。

---

## 3. PKE 模块的掩码协同 (Mask-Guided PKE)

**PKE (筛选式关键点扩充)** 是 SuperRetina 的核心。引入掩码可以极大降低监督学习初期的噪声。

### 筛选逻辑改进:

在原有的**几何校验**和**内容校验**(双重匹配)基础上,增加**掩码一致性校验**:

1.  **原有流程**: 通过 $\mathcal{H}^{-1}$ 反投影寻找重现点 $S$,并进行 Lowe's Ratio Test。

2.  **新增掩码过滤**:
    $$\hat{S}_{final} = \{(i, j) \in \hat{S} \mid M^{vessel}(i, j) > 0.5\}$$

3.  **动态标签更新**: $Y_t = Y_0 \cup \hat{S}_{final}$。

*   **作用**: 在训练初期,强制模型更新学习到的"关键点"必须落在血管掩码内,这能防止模型在缺乏边缘或像素对比度的区域学习到错误的"关键点",提高在大角度转下的配准稳定性。

---

## 4. 训练策略:三阶段课程学习 (Curriculum Learning)

为了解决"测试时无掩码"的问题,采用**渐衰权重 λ** 调节掩码的影响力。

| 阶段 | 周期 (Epochs) | 掩码权重作用 | 目的 |
|------|---------------|--------------|------|
| **1. 全局感知期** | 0 - 30 | min 权重 =0.3 | 让模型利用全局信息(含背景)学习初步的 ±30° 几何对齐。 |
| **2. 血管聚焦期** | 30 - 60 | min 权重 =0.1 | **强化血管引导**。PKE 大量引入血管分叉点,模型学习跨模态的关键点对应细微拓扑特征。 |
| **3. 泛化增强期** | 60 - 100 | min 权重 =0.5 | 减弱掩码对比度。模型"无掩码"环境,确保模型仅识别出血管关键点也能对齐出血管关键点。 |
| **4. 完全泛化期** | 100+ | min 权重 =0 (不使用掩码) | **掩码权重归零**。模型完全依赖学到的特征进行配准,模拟真实测试环境。 |

---

## 5. 数据构造与空间变换

每一轮迭代中,我们利用对齐的图像对构造具有几何偏差的跨模态输入:

*   **输入对**: 固定图像 $I_{fix}$ (CF 模态) 和原始运动图像 $I_{mo}$ (FA 或 OCT 模态)。
*   **初始种子点 ($Y_0$)**: 在 $I_{fix}$ 上使用 PBO 算法自动提取血管交叉点和分叉点。
*   **几何扰动 ($\mathcal{H}$)**: 随机生成单应性矩阵 $\mathcal{H}$,对 $I_{mo}$ 进行变换:
    $$I_{moving} = \text{Warp}(I_{mo}, \mathcal{H})$$
*   **变换范围**: 旋转 $\theta \in [-30^\circ, 30^\circ]$,平移 $t \in [0.1, 0.2] \times \text{Size}$。
*   **血管掩码同步变换**: $M_{vessel}^{moving} = \text{Warp}(M_{vessel}, \mathcal{H})$

---

## 6. 网络前向传播

$I_{fix}$ 和 $I_{moving}$ 分别通过共享权重的编码器及双解码器:

*   **检测图 (Detection Map)**: 输出 $P$ 和 $P'$,表示每个像素是关键点的概率。
*   **描述子张量 (Descriptor Tensor)**: 输出 $D$ 和 $D'$,维度均为 $h \times w \times 256$。

**重要**: 血管掩码**不**作为输入送入 Encoder,仅用于损失计算和 PKE。

---

## 7. 推断与配准 (Inference & Registration)

针对大尺度旋转,采用基于特征点的全局解算:

1.  **特征点检测**: 对待配准图 $I_1, I_2$ 提取关键点集 $Kp_1, Kp_2$。
2.  **特征匹配**: 基于 256 维描述子的欧氏距离进行暴力匹配。
3.  **单应性解算**:
    $$\hat{\mathcal{H}} = \text{RANSAC}(\text{Matches}(Kp_1, Kp_2))$$

*   **优点**: 即使存在 $30^\circ$ 旋转或大面积偏移,只要存在 4 个以上的正确匹配点,RANSAC 即可实现像素级对齐。

---

## 总结

通过上述改进,SuperRetina 可以在训练时充分利用血管掩码引导学习关键的血管特征点,同时通过梯度保底和课程学习策略确保模型在推理时(无掩码情况下)依然具有极强的泛化能力和大尺度配准鲁棒性。